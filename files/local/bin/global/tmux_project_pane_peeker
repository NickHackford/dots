#!/usr/bin/env bash

# FZF-based project pane picker with live preview
# Usage: tmux_project_pane_peeker <pane_type>
# Example: tmux_project_pane_peeker agent
#          tmux_project_pane_peeker nvim

# Check if argument is provided
if [[ $# -eq 0 ]]; then
    echo "Usage: $0 <pane_type>"
    echo "Example: $0 agent"
    echo "         $0 nvim"
    echo "         $0 yazi"
    exit 1
fi

pane_type="$1"

# Map special type names to grep patterns
get_type_pattern() {
    case "$1" in
        bender) echo "bender-proxy$\|bend-reactor$" ;;
        *) echo "$1\$" ;;
    esac
}

# Get all project panes of the specified type and format them nicely
get_project_panes() {
    local pattern=$(get_type_pattern "$pane_type")
    
    # Query panes by @pane_type across ALL sessions
    # Include @pane_status for agent status detection (set by indicator plugin)
    tmux list-panes -a -F "#{session_name}|#{pane_id}|#{pane_current_command}|#{@pane_status}|#{@pane_type}" |
        grep "|${pattern}" |
        while IFS='|' read -r session_name pane_id current_command pane_status pane_type_val; do
            # Determine status icon
            local symbol=""
            if [[ "$current_command" != "bash" && "$current_command" != "zsh" && "$current_command" != "sh" ]]; then
                case "$pane_type_val" in
                    agent)
                        # Check @pane_status set by indicator plugin
                        case "$pane_status" in
                            working) symbol="󰜎" ;;
                            waiting) symbol="" ;;
                            seen) symbol="" ;;
                            *) symbol="" ;;  # idle or not set
                        esac
                        ;;
                    bender-proxy|bend-reactor) symbol="󰚩" ;;
                    *) symbol="" ;;
                esac
            else
                symbol=""
            fi
            printf "%s %s %-20s %s\n" "$pane_id" "$symbol" "$current_command" "$session_name"
        done
}

# Use fzf to select and preview
selected=$(get_project_panes | fzf \
    --ansi \
    --layout=reverse \
    --border \
    --with-nth=2.. \
    --preview="
        pane_id=\$(echo {} | awk '{print \$1}')
        session_name=\$(echo {} | awk '{print \$4}')
        preview_height=\$(($(tput lines) - 7))
        echo \"=== \$session_name (${pane_type} pane) ===\"
        echo
        tmux capture-pane -t \"\$pane_id\" -e -p | grep -v '^[[:space:]]*\$' | tail -\$preview_height
    " \
    --preview-window=right:60% \
    --header="Select the ${pane_type} pane to switch to")

if [[ -n "$selected" ]]; then
    pane_id=$(echo "$selected" | awk '{print $1}')

    # Clear notification status if pane is idle (not working/waiting)
    # This marks it as "seen" so we know we've checked it
    pane_status=$(tmux display-message -p -t "$pane_id" '#{@pane_status}')
    if [[ "$pane_status" != "working" && "$pane_status" != "waiting" ]]; then
        tmux set-option -p -t "$pane_id" @pane_status "seen"
    fi

    # Get the window containing this pane
    target_window=$(tmux list-panes -a -F "#{pane_id} #{session_name}:#{window_id}" | grep "^$pane_id " | cut -d' ' -f2)

    # Switch to the session and window, then select the pane
    tmux switch-client -t "$target_window"
    tmux select-pane -t "$pane_id"
fi
