#!/usr/bin/env bash

# FZF-based project pane picker with live preview
# Usage: tmux_project_pane_peeker <pane_type>
# Example: tmux_project_pane_peeker agent  # looks for agent_pane
#          tmux_project_pane_peeker nvim   # looks for nvim_pane

# Check if argument is provided
if [[ $# -eq 0 ]]; then
    echo "Usage: $0 <pane_type>"
    echo "Example: $0 agent"
    echo "         $0 nvim"
    echo "         $0 yazi"
    exit 1
fi

pane_type="$1"

# Get all project panes of the specified type and format them nicely
get_project_panes() {
    local panes_data
    panes_data=$(tmux list-panes -a -F "#{?pane_bell,*,#{?window_bell_flag,*,#{?window_activity_flag,~,-}}} #{session_name} #{pane_id} #{pane_start_command}" |
        grep ": ${pane_type}_pane;")

    local max_session_width
    max_session_width=$(($(tput cols) * 40 / 100 - 11))

    # Format with calculated width
    echo "$panes_data" | while read symbol session_name pane_id start_command; do
        printf "%-1s %-${max_session_width-6}s %s\n" "$symbol" "$session_name" "$pane_id"
    done
}

# Use fzf to select and preview
selected=$(get_project_panes | sort -k1,1r | fzf \
    --ansi \
    --layout=reverse \
    --border \
    --preview="
        session_name=\$(echo {} | awk '{print \$2}')
        pane_id=\$(echo {} | awk '{print \$3}')
        preview_height=\$(($(tput lines) - 7))
        echo \"=== \$session_name (${pane_type} pane) ===\"
        echo
        tmux capture-pane -t \"\$pane_id\" -e -p | grep -v '^[[:space:]]*$' | tail -\$preview_height
    " \
    --preview-window=right:60% \
    --header="Select the ${pane_type} pane to switch to")

if [[ -n "$selected" ]]; then
    session_name=$(echo "$selected" | awk '{print $2}')
    pane_id=$(echo "$selected" | awk '{print $3}')

    # Get the window containing this pane
    target_window=$(tmux list-panes -a -F "#{pane_id} #{session_name}:#{window_id}" | grep "$pane_id" | cut -d' ' -f2)

    # Switch to the session and window, then select the pane
    tmux switch-client -t "$target_window"
    tmux select-pane -t "$pane_id"
fi
