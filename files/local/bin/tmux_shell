#!/usr/bin/env bash

# Source helper functions
source "$(dirname "${BASH_SOURCE[0]}")/tmux_helpers"

# Function to check if a port is available
is_port_available() {
    local port=$1
    # Use bash built-in TCP redirection (fastest method)
    ! timeout 0.1 bash -c "</dev/tcp/localhost/$port" 2>/dev/null
}

# Function to find available port pair
find_available_ports() {
    local base_port=5000
    while true; do
        local http_port=$base_port
        local https_port=$((base_port + 1))

        if is_port_available $http_port && is_port_available $https_port; then
            echo "$http_port $https_port"
            return 0
        fi

        base_port=$((base_port + 10))

        # Safety check to avoid infinite loop
        if [ $base_port -gt 9000 ]; then
            echo "ERROR: Could not find available port pair" >&2
            return 1
        fi
    done
}

# Check for package.json with bpm section
has_bpm_section() {
    [ -f "package.json" ] && grep -q '"bpm"' package.json
}

# Check if shell pane exists and switch to it
if pane_exists "Shell:"; then
    switch_to_titled_pane "Shell:"
else
    # Check if current pane has default title - use it instead of creating new window
    if is_current_pane_default; then
        # Convert current pane to shell pane
        convert_current_pane "Shell:" "shell"
    else
        # Create new shell window
        create_titled_window "Shell:" "shell"
    fi
    
    # Check if this is a bpm project and type bender_port command
    if has_bpm_section; then
        # Type the bender_port command but don't execute it
        tmux send-keys "bender_port"
    fi
fi